# **操作系统专题实践课程报告**

**姓名**：段嘉文  
**学号**：71123329  
**专业**：软件工程  

---

## 一、实验概述

1. **内核级进程隐藏系统调用**：在 Linux 5.13.10 内核中新增 `sys_hide` 系统调用，通过状态标记与 `/proc` 过滤实现安全、可逆的进程可见性控制；  
2. **用户态 Shell 命令解释器**：从零实现支持交互/批处理模式、管道、重定向与内置命令的完整 Shell。  

---

## 二、实验一：Linux 进程管理扩展

### 核心设计
- **非侵入式隐藏机制**：在 `task_struct` 中新增 `cloak` 标志位（0：可见，1：隐藏），避免直接操作进程链表；
- **全局开关控制**：通过 `/proc/hide` 接口动态启停隐藏功能（`hidden_flag` 全局变量）；
- **运行时监控**：通过 `/proc/hidden_process` 列出当前所有被隐藏的进程 PID；
- **权限控制**：仅 `root`（`CAP_SYS_ADMIN`）可调用隐藏接口，保障系统安全。

<img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\6.png" alt="6" style="zoom:33%;" />

1.修改`task_struct`

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\7.png" alt="7" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\8.png" alt="8" style="zoom: 17%;" />
</div>

2.修改procfs

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\9.png" alt="9" style="zoom: 23%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\10.png" alt="10" style="zoom: 18%;" />
</div>

3.添加系统调用及相关接口

**（1）新建全局变量声明文件**

在`include/linux`目录下新建`var_defs.h`头文件，声明全局隐藏开关变量`hidden_flag`，便于其他内核模块引用。

**（2）实现`sys_hide`系统调用、实现`sys_hide_user_processes`系统调用**

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\12.png" alt="12" style="zoom: 23%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\13.png" alt="13" style="zoom: 22%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\14.png" alt="14" style="zoom: 24%;" />
</div>




**（3）创建`/proc/hide`控制接口、创建`/proc/hidden_process`查询接口**

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\15.png" alt="15" style="zoom: 24%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\16.png" alt="16" style="zoom: 24%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\17.png" alt="17" style="zoom:24%;" />
</div>
**（4）修改编译配置文件、注册系统调用**

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\18.png" alt="18" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\19.png" alt="19" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\20.png" alt="20" style="zoom:25%;" />
</div>
### 验证结果

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\22.png" alt="22" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\23.png" alt="23" style="zoom: 25%;" />
</div>

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\24.png" alt="24" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_1.assets\25.png" alt="25" style="zoom: 25%;" />
</div>


---

## 三、实验二：Shell 命令行解释器

### 核心设计
- **模块化架构**：分离命令解析、进程执行、重定向、管道处理等模块；
- **内置命令直执**：`cd`、`exit`、`path`、`help` 由主进程直接执行，确保环境变量/工作目录有效更新；
- **管道机制**：为 n 个命令创建 n−1 个匿名管道，按位置连接 stdin/stdout；
- **重定向处理**：通过 `dup2()` + `open()` 支持 `<`、`>`、`>>`，可与管道组合使用。

数据结构定义、宏定义与常量

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\1.png" alt="1" style="zoom:17%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\2.png" alt="2" style="zoom:21%;" />
</div>

工具函数模块实现

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\3.png" alt="3" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\4.png" alt="4" style="zoom: 22%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\5.png" alt="5" style="zoom: 25%;" />
</div>



<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\6.png" alt="6" style="zoom: 20%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\7.png" alt="7" style="zoom: 20%;" />
</div>

命令执行模块实现

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\8.png" alt="8" style="zoom: 20%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\9.png" alt="9" style="zoom: 21%;" />
</div>


### 验证结果
执行`./myshell`启动交互模式，Shell显示欢迎信息和彩色提示符，格式为`用户名@主机名:当前路径$`。

<img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\13.png" alt="13" style="zoom: 25%;" />

编写批处理测试脚本，执行`./myshell batch.txt`，Shell按顺序执行文件中的每条命令，输出完整的执行结果。

<div style="display: flex; justify-content: center; gap: 10px; align-items: center; flex-wrap: nowrap;">
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\24.png" alt="24" style="zoom: 25%;" />
    <img src="E:\25-26-2\OSEXP\OSEXP\OSEXP-master\os_lab_2.assets\25.png" alt="25" style="zoom: 25%;" />
</div>


---

## 四、实验总结与体会

1. **内核与用户态开发差异显著**：  
   内核开发受限于无标准库、调试手段有限，必须极度严谨；用户态可利用丰富工具（如 gdb、valgrind），开发效率更高。

2. **安全与可维护性优先**：  
   进程隐藏未采用链表摘除，而是通过标志位+过滤，避免结构破坏；Shell 的内置命令由主进程处理，确保环境一致性。

3. **细节决定成败**：  
   Shell 的管道描述符管理、重定向的 `O_APPEND` 与 `O_TRUNC` 区分、内核中 `proc_flush_pid()` 的调用时机，均需精确处理。

4. **工程能力全面提升**：  
   从内核裁剪与编译（`make localmodconfig`）、到模块化编码、再到多维度测试，掌握了系统级开发完整流程。

综上，两项实验从底层内核到用户接口，全面深化了对操作系统核心机制的理解，为后续学习工作中开发奠定了基础。
